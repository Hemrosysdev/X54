/*
 * EspLedcTimer.cpp
 *
 *  Created on: 05.11.2019
 *      Author: gesser
 */

#include "EspLedcTimer.h"

#include <driver/ledc.h>

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

namespace UxEspCppLibrary
{

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

EspLedcTimer::EspLedcTimer()
                : EspLog( "EspLedcTimer" )
                  , m_nSpeedMode( LEDC_LOW_SPEED_MODE )
                  , m_nTimerNum( LEDC_TIMER_MAX )
                  , m_nBitNum( LEDC_TIMER_BIT_MAX )
                  , m_u32FreqHz( 0 )
                  {
                  }

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

EspLedcTimer::EspLedcTimer( const std::string & strLogName )
: EspLog( strLogName )
, m_nSpeedMode( LEDC_LOW_SPEED_MODE )
, m_nTimerNum( LEDC_TIMER_MAX )
, m_nBitNum( LEDC_TIMER_BIT_MAX )
, m_u32FreqHz( 0 )
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

EspLedcTimer::~EspLedcTimer()
{
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

esp_err_t EspLedcTimer::init( const ledc_mode_t nSpeedMode,
                              const ledc_timer_bit_t nBitNum,
                              const ledc_timer_t nTimerNum,
                              const uint32_t u32FreqHz )
{
    m_nSpeedMode = nSpeedMode;
    m_nTimerNum  = nTimerNum;
    m_nBitNum    = nBitNum;
    m_u32FreqHz  = u32FreqHz;

    ledc_timer_config_t ledcTimerConfig;
    ledcTimerConfig.speed_mode      = m_nSpeedMode; // timer mode,
    ledcTimerConfig.duty_resolution = m_nBitNum;    // set timer counter bit number
    ledcTimerConfig.timer_num       = m_nTimerNum;  // timer index
    ledcTimerConfig.freq_hz         = m_u32FreqHz;   // set frequency of pwm
    ledcTimerConfig.clk_cfg         = LEDC_USE_APB_CLK;

    //configure timer0 for high speed channels
    return ledc_timer_config( &ledcTimerConfig );
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ledc_mode_t EspLedcTimer::speedMode( void ) const
{
    return m_nSpeedMode;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ledc_timer_t EspLedcTimer::timerNum( void ) const
{
    return m_nTimerNum;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

ledc_timer_bit_t EspLedcTimer::bitNum( void ) const
{
    return m_nBitNum;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

uint32_t EspLedcTimer::freqHz( void ) const
{
    return m_u32FreqHz;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

esp_err_t EspLedcTimer::setFreqHz( const uint32_t u32FreqHz )
{
    esp_err_t nEspError = ESP_OK;

    if ( m_u32FreqHz != u32FreqHz )
    {
        nEspError = ledc_set_freq( m_nSpeedMode, m_nTimerNum, u32FreqHz );
    }

    return nEspError;
}

/*!************************************************************************************************************************************************************
 *
 *************************************************************************************************************************************************************/

} // namespace UxEspCppLibrary

